<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Licznik Punktów - Tysiąc</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .card {
            background-color: #1e293b; /* slate-800 */
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1rem; /* p-4 */
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease-in-out;
        }
        .card.is-leader {
            background-color: #334155;
            border: 2px solid #fcd34d;
            box-shadow: 0 0 15px rgba(253, 230, 138, 0.4);
        }
        .btn {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            text-align: center;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            cursor: pointer;
        }
        .btn-primary { background-color: #14b8a6; color: white; }
        .btn-primary:hover { background-color: #0d9488; }
        .btn-secondary { background-color: #475569; color: #f1f5f9; }
        .btn-secondary:hover { background-color: #334155; }
        .btn-disabled {
            background-color: #334155;
            color: #94a3b8;
            cursor: not-allowed;
            opacity: 0.7;
            pointer-events: none;
        }
        .btn-disabled:hover { background-color: #334155; }
        .input-field {
            width: 100%;
            background-color: #334155;
            border: 1px solid #475569;
            color: #f1f5f9;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: #14b8a6;
            box-shadow: 0 0 0 2px #14b8a680;
        }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        #round-history-container table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        #round-history-container th, #round-history-container td { padding: 0.3rem 0.2rem; text-align: center; }
        #round-history-container th {
            background-color: #334155; font-weight: 600; border-bottom: 2px solid #1e293b;
            position: sticky; top: 0; z-index: 10;
        }
        #round-history-container tr:nth-child(even) { background-color: #2d3846; }
        .history-score { font-weight: 600; color: #14b8aa; }
        .score-danger { color: #fdee00; }
        .score-negative { color: #f87171; }

.app-footer {
    text-align: center;
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 1px solid #ddd;
    font-size: 0.75rem;
    color: #666;
}
        
    </style>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

</head>
<body class="bg-slate-900 text-slate-100 flex items-center justify-center min-h-screen p-3">

    <div class="w-full max-w-4xl mx-auto">
        <header class="text-center mb-4">
            <h5 class="text-2xl font-bold text-teal-400">Licznik Punktów - Tysiąc</h5>
        </header>

        <div id="setup-screen" class="card space-y-3">
            <h2 class="text-lg font-semibold text-center">Nowa Gra</h2>
            <div>
                <label for="player-count" class="block mb-1 text-sm font-medium text-slate-300">Liczba graczy:</label>
                <select id="player-count" class="input-field">
                    <option value="2" selected>2 graczy</option>
                    <option value="3">3 graczy</option>
                    <option value="4">4 gracze</option>
                </select>
            </div>
            <div id="player-names-container" class="space-y-2"></div>
            <div class="flex flex-col sm:flex-row gap-2">
                <button id="start-game-btn" class="btn btn-primary w-full">Rozpocznij Grę</button>
                <button id="show-stats-btn" class="btn btn-secondary w-full">Pokaż Statystyki</button>
            </div>
        </div>

        <div id="game-screen" class="hidden">
            <div id="status-message-container" class="text-center mb-4"></div>
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-2">
                 <div id="round-info-display" class="bg-slate-700 p-2 rounded-lg text-center text-sm font-medium w-full sm:w-auto flex-grow"></div>
                <button id="rotate-first-player-btn" class="btn btn-secondary text-xs px-2 py-1 flex-shrink-0">
                    Ręcznie obróć gracza rozpoczynającego ♛
                </button>
            </div>
            <div id="scoreboard" class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4"></div>
            <div class="card space-y-3 mb-4">
                <h3 class="text-base font-semibold">Dodaj punkty za rundę:</h3>
                <div id="score-inputs" class="grid grid-cols-2 md:grid-cols-4 gap-2"></div>
                <button id="add-round-btn" class="btn btn-primary w-full">Dodaj Wynik Rundy</button>
            </div>
            <div class="card mb-4">
                <h3 class="text-sm font-semibold mb-2">Historia Rund (Usuń wpis):</h3>
                <div id="round-history-container" class="max-h-32 overflow-y-auto"></div>
            </div>
            <div class="flex flex-row gap-2">
                <button id="game-to-stats-btn" class="btn btn-secondary w-1/2">Statystyki</button>
                <button id="back-to-menu-btn" class="btn bg-red-600 hover:bg-red-700 text-white w-1/2">Porzuć Grę / Nowa Gra</button>
            </div>
        </div>

        <!-- ZMIANA: Usunięto div#stats-history -->
        <div id="stats-screen" class="hidden card space-y-4">
            <h2 class="text-lg font-semibold text-center">Statystyki Gier</h2>
            <div id="stats-summary" class="text-center bg-slate-700 p-3 rounded-lg"></div>
            <div class="flex flex-col sm:flex-row gap-2">
                <button id="back-from-stats-btn" class="btn btn-primary w-full">Wróć</button>
                <button id="clear-stats-btn" class="btn bg-red-600 hover:bg-red-700 text-white w-full">Wyczyść Statystyki</button>
            </div>
        </div>

        <div id="winner-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4 z-40">
            <div class="card text-center space-y-3 max-w-sm w-full">
                <h2 class="text-xl font-bold text-teal-400">Koniec Gry!</h2>
                <p id="winner-message" class="text-base"></p>
                <div id="final-scores" class="text-left space-y-1 text-sm"></div>
                <button id="modal-back-to-menu-btn" class="btn btn-primary w-full">Powrót do Menu</button>
            </div>
        </div>

        <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4 z-50">
            <div class="card text-center space-y-4 max-w-xs w-full">
                <p id="confirm-message" class="text-base font-medium"></p>
                <div class="flex gap-3 justify-center">
                    <button id="confirm-yes-btn" class="btn bg-red-600 hover:bg-red-700 text-white w-1/2">Tak</button>
                    <button id="confirm-no-btn" class="btn btn-secondary w-1/2">Anuluj</button>
                </div>
            </div>
        </div>
        <footer class="app-footer">
            <p>Stworzone przez <strong>Łukasz Stężycki</strong>. © 2025</p>
            <!-- Możesz też dodać link do swojego portfolio lub GitHub, np: -->
            <!-- <p><a href="https://github.com/twoj-profil" target="_blank">Zobacz kod na GitHub</a></p> -->
        </footer>
    </div>

<script>
    // Konfiguracja Firebase (bez zmian)
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyD44JW-x135PT51t2Uzc_JotiEVtuO3Rig",
      authDomain: "tysiac-881c3.firebaseapp.com",
      projectId: "tysiac-881c3",
      storageBucket: "tysiac-881c3.firebasestorage.app",
      messagingSenderId: "855690860515",
      appId: "1:855690860515:web:6b4b95a5de2d4f9997b2d6",
      measurementId: "G-H5RSQYCFFN"
    };

    try {
        firebase.initializeApp(FIREBASE_CONFIG);
        var db = firebase.firestore();
        console.log("Firebase i Firestore zainicjowane pomyślnie.");
    } catch (e) {
        console.error("Błąd inicjalizacji Firebase!", e);
        var db = null;
    }
    
    // Referencje DOM (bez zmian)
    const setupScreen = document.getElementById('setup-screen');
    const gameScreen = document.getElementById('game-screen');
    const statsScreen = document.getElementById('stats-screen');
    const winnerModal = document.getElementById('winner-modal');
    const confirmModal = document.getElementById('confirm-modal');
    const confirmMessage = document.getElementById('confirm-message');
    const confirmYesBtn = document.getElementById('confirm-yes-btn');
    const confirmNoBtn = document.getElementById('confirm-no-btn');
    const playerCountSelect = document.getElementById('player-count');
    const playerNamesContainer = document.getElementById('player-names-container');
    const startGameBtn = document.getElementById('start-game-btn');
    const showStatsBtn = document.getElementById('show-stats-btn');
    const scoreboard = document.getElementById('scoreboard');
    const scoreInputs = document.getElementById('score-inputs');
    const addRoundBtn = document.getElementById('add-round-btn');
    const backToMenuBtn = document.getElementById('back-to-menu-btn');
    const rotateFirstPlayerBtn = document.getElementById('rotate-first-player-btn');
    const gameToStatsBtn = document.getElementById('game-to-stats-btn');
    const roundHistoryContainer = document.getElementById('round-history-container');
    const statsSummary = document.getElementById('stats-summary');
    const backFromStatsBtn = document.getElementById('back-from-stats-btn');
    const clearStatsBtn = document.getElementById('clear-stats-btn');
    const modalBackToMenuBtn = document.getElementById('modal-back-to-menu-btn');
    const roundInfoDisplay = document.getElementById('round-info-display');
    const statusMessageContainer = document.getElementById('status-message-container');

    // Stan Aplikacji (bez zmian)
    let gameState = { players: [], history: [], isActive: false, firstPlayerIndex: 0, initialFirstPlayerIndex: 0 };
    const GAME_STATE_KEY = 'tysiacGameState';
    const defaultPlayerNames = ['Kulik', 'Miś', 'Gracz 3', 'Gracz 4'];
    const LEADER_CLASS = 'is-leader';

    // ZMIANA: Pozostaje tylko stała dla statystyk zwycięstw
    const FIREBASE_COLLECTION_WINS = 'tysiac_win_stats';

    // --- Funkcje logiki gry (bez większych zmian) ---
    // (Pominięto dla zwięzłości, kod jest identyczny jak poprzednio)
    let messageTimeout;
    function showTemporaryMessage(message, isError = false) { statusMessageContainer.innerHTML = `<div class="p-2 rounded-lg ${isError ? 'bg-red-800 text-white' : 'bg-yellow-600 text-slate-900'} font-semibold">${message}</div>`; clearTimeout(messageTimeout); messageTimeout = setTimeout(() => { statusMessageContainer.innerHTML = ''; }, 5000); }
    function renderRoundInfo() { if (!gameState.isActive) return; const currentRound = gameState.history.length + 1; const firstPlayerName = gameState.players[gameState.firstPlayerIndex].name; roundInfoDisplay.innerHTML = `<span class="text-slate-300">Runda: </span><span class="text-teal-400 font-bold">${currentRound}</span><span class="text-slate-300 ml-4 hidden sm:inline-block">|</span><span class="text-slate-300 ml-4">Na musiku: </span><span class="text-amber-400 font-bold">${firstPlayerName} </span>`; const isRound1 = gameState.history.length === 0; rotateFirstPlayerBtn.classList.toggle('btn-disabled', !isRound1); rotateFirstPlayerBtn.disabled = !isRound1; rotateFirstPlayerBtn.title = isRound1 ? "Dostępne tylko w Rundzie 1." : "Blokada: Dostępne tylko w Rundzie 1."; }
    function recalculateScores() { gameState.players.forEach(p => p.score = 0); gameState.history.forEach(round => { gameState.players.forEach(player => { player.score += round[player.name] || 0; }); }); if (gameState.players.length === 2) { gameState.firstPlayerIndex = gameState.history.length % 2 === 0 ? gameState.initialFirstPlayerIndex : (gameState.initialFirstPlayerIndex + 1) % 2; } else { gameState.firstPlayerIndex = (gameState.initialFirstPlayerIndex + gameState.history.length) % gameState.players.length; } updateScoreValues(); updateFirstPlayerMarker(); renderRoundHistory(); renderRoundInfo(); saveGameState(); }
    function addRoundScore() { const roundScores = {}; let validationFailed = false, roundingOccurred = false; const firstInput = document.getElementById('score-input-0'); for (let i = 0; i < gameState.players.length; i++) { const player = gameState.players[i], input = document.getElementById(`score-input-${i}`); let scoreValue = parseInt(input.value, 10) || 0; if (scoreValue !== 0) { if (player.score >= 800 && scoreValue > 0 && scoreValue < 100) { validationFailed = true; input.value = ''; break; } if (scoreValue > 0) { let roundedScore = Math.round(scoreValue / 10) * 10; if (roundedScore !== scoreValue) roundingOccurred = true; scoreValue = roundedScore; input.value = scoreValue; } } roundScores[player.name] = scoreValue; } if (validationFailed) { showTemporaryMessage('Gracz z wynikiem 800+ musi ugrać minimum 100 punktów (dla punktów dodatnich).', true); firstInput?.focus(); return; } gameState.players.forEach(p => p.score += roundScores[p.name]); gameState.history.unshift(roundScores); if (gameState.players.length === 2) { gameState.firstPlayerIndex = gameState.history.length % 2 !== 0 ? (gameState.initialFirstPlayerIndex + 1) % 2 : gameState.initialFirstPlayerIndex; } else { gameState.firstPlayerIndex = (gameState.firstPlayerIndex + 1) % gameState.players.length; } updateScoreValues(); updateFirstPlayerMarker(); renderRoundHistory(); checkWinner(); saveGameState(); gameState.players.forEach((_, i) => document.getElementById(`score-input-${i}`).value = ''); if (roundingOccurred) showTemporaryMessage('Wynik dodatni został zaokrąglony do najbliższej 10-tki.', false); renderRoundInfo(); firstInput?.focus(); }
    function renderRoundHistory() { if (gameState.history.length === 0) { roundHistoryContainer.innerHTML = '<p class="text-slate-500 text-xs text-center p-2">Brak dodanych rund.</p>'; return; } let headerHtml = '<tr><th class="w-1/6">Runda</th>'; gameState.players.forEach(p => headerHtml += `<th class="whitespace-nowrap" title="${p.name}">${p.name.length > 5 ? p.name.substring(0, 5) + '.' : p.name}</th>`); headerHtml += '<th class="w-1/12">Akcje</th></tr>'; let bodyHtml = ''; gameState.history.forEach((round, index) => { const roundNumber = gameState.history.length - index; let rowHtml = `<tr><td>${roundNumber}</td>`; gameState.players.forEach(p => rowHtml += `<td class="${(round[p.name] || 0) < 0 ? 'score-negative' : 'history-score'}">${round[p.name] || 0}</td>`); rowHtml += `<td><button onclick="confirmDeleteRound(${index})" class="text-red-500 hover:text-red-400 p-0.5 rounded"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mx-auto" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button></td></tr>`; bodyHtml += rowHtml; }); roundHistoryContainer.innerHTML = `<table><thead>${headerHtml}</thead><tbody>${bodyHtml}</tbody></table>`; }
    window.confirmDeleteRound = function(i) { showCustomConfirm('Czy na pewno chcesz usunąć tę rundę?', () => deleteRound(i)); }
    function deleteRound(i) { gameState.history.splice(i, 1); recalculateScores(); checkWinner(); }
    function handleInputKeydown(e) { if (e.key === 'Enter') { e.preventDefault(); const currentIndex = parseInt(e.target.dataset.playerIndex, 10); const nextIndex = currentIndex + 1; if (nextIndex < gameState.players.length) document.getElementById(`score-input-${nextIndex}`)?.focus(); else addRoundScore(); } }
    function renderGameScreen() { scoreboard.innerHTML = ''; scoreInputs.innerHTML = ''; gameState.players.forEach((player, i) => { scoreboard.innerHTML += `<div class="card text-center"><div id="player-name-${i}" class="text-sm font-semibold flex items-center justify-center gap-1">${player.name}</div><div id="player-score-${i}" class="text-3xl font-bold mt-1 ${player.score >= 800 ? 'score-danger' : 'text-teal-400'}">${player.score}</div></div>`; scoreInputs.innerHTML += `<div><label for="score-input-${i}" class="block mb-1 text-xs font-medium text-slate-400">${player.name}</label><input type="number" id="score-input-${i}" class="input-field text-center text-sm" placeholder="0" data-player-index="${i}"></div>`; document.getElementById(`score-input-${i}`).addEventListener('keydown', handleInputKeydown); }); updateScoreValues(); updateFirstPlayerMarker(); renderRoundHistory(); renderRoundInfo(); document.getElementById('score-input-0')?.focus(); }
    function updateScoreValues() { const maxScore = Math.max(...gameState.players.map(p => p.score)); gameState.players.forEach((p, i) => { const scoreEl = document.getElementById(`player-score-${i}`); const cardEl = scoreboard.children[i]; if (scoreEl) { scoreEl.textContent = p.score; scoreEl.classList.toggle('score-danger', p.score >= 800); scoreEl.classList.toggle('text-teal-400', p.score < 800); } if (cardEl) cardEl.classList.toggle(LEADER_CLASS, p.score === maxScore && maxScore > 0); }); }
    function generatePlayerNameInputs() { const count = parseInt(playerCountSelect.value, 10); playerNamesContainer.innerHTML = ''; for (let i = 1; i <= count; i++) { playerNamesContainer.innerHTML += `<div><label for="player${i}" class="block mb-1 text-sm font-medium text-slate-400">Imię gracza ${i}:</label><input type="text" id="player${i}" class="input-field" placeholder="Gracz ${i}" value="${defaultPlayerNames[i - 1] || `Gracz ${i}`}"></div>`; } }
    function startGame() { const players = []; let hasValidNames = true; for (let i = 1; i <= parseInt(playerCountSelect.value, 10); i++) { const input = document.getElementById(`player${i}`); const name = input.value.trim(); if (name === '') { input.style.borderColor = 'red'; hasValidNames = false; } else { input.style.borderColor = ''; players.push({ name: name, score: 0 }); } } if (!hasValidNames) { showCustomAlert('Wszystkie pola z imionami muszą być wypełnione.'); return; } gameState = { players, history: [], isActive: true, firstPlayerIndex: 0, initialFirstPlayerIndex: 0 }; saveGameState(); renderGameScreen(); setupScreen.classList.add('hidden'); statsScreen.classList.add('hidden'); gameScreen.classList.remove('hidden'); }
    function checkWinner() { const winners = gameState.players.filter(p => p.score >= 1000); if (winners.length > 0) { const winner = winners.reduce((prev, curr) => (prev.score > curr.score) ? prev : curr); endGame(winner); } }
    function endGame(winner) { if (gameState.isActive) saveStats(winner); document.getElementById('winner-message').textContent = `Wygrywa ${winner.name}! Gratulacje!`; document.getElementById('final-scores').innerHTML = '<h4>Końcowe wyniki:</h4>' + gameState.players.map(p => `<div class="flex justify-between"><span>${p.name}:</span><span class="font-semibold">${p.score} pkt</span></div>`).join(''); winnerModal.classList.remove('hidden'); winnerModal.classList.add('flex'); clearGameState(); }
    function resetGame() { clearGameState(); gameScreen.classList.add('hidden'); statsScreen.classList.add('hidden'); winnerModal.classList.add('hidden'); winnerModal.classList.remove('flex'); setupScreen.classList.remove('hidden'); generatePlayerNameInputs(); }
    function saveGameState() { if (gameState.isActive) localStorage.setItem(GAME_STATE_KEY, JSON.stringify(gameState)); }
    function loadGameState() { const savedState = localStorage.getItem(GAME_STATE_KEY); if (savedState) { const loadedState = JSON.parse(savedState); if (typeof loadedState.initialFirstPlayerIndex === 'undefined') loadedState.initialFirstPlayerIndex = 0; gameState = loadedState; if (gameState.players?.length > 0) { gameState.isActive = true; renderGameScreen(); setupScreen.classList.add('hidden'); gameScreen.classList.remove('hidden'); return true; } else { clearGameState(); } } return false; }
    function clearGameState() { gameState = { players: [], history: [], isActive: false, firstPlayerIndex: 0, initialFirstPlayerIndex: 0 }; localStorage.removeItem(GAME_STATE_KEY); }
    function updateFirstPlayerMarker() { gameState.players.forEach((p, i) => { const nameEl = document.getElementById(`player-name-${i}`); if (nameEl) { let markers = ''; if (i === gameState.firstPlayerIndex) markers += '<span class="text-amber-400 text-xs ml-1" title="Na musiku">musik</span>'; if (i === gameState.initialFirstPlayerIndex) markers += '<span class="text-red-400 text-xs ml-1 font-bold" title="Rozpoczynający RUNDĘ 1">START</span>'; nameEl.innerHTML = `${p.name} ${markers}`; } }); }
    function rotateFirstPlayer() { if (gameState.history.length > 0) { showTemporaryMessage('Zmiana możliwa tylko w Rundzie 1.', true); return; } if (!gameState.isActive || gameState.players.length < 2) return; gameState.firstPlayerIndex = (gameState.firstPlayerIndex + 1) % gameState.players.length; gameState.initialFirstPlayerIndex = gameState.firstPlayerIndex; updateFirstPlayerMarker(); renderRoundInfo(); saveGameState(); }
    function handleBackFromStats() { statsScreen.classList.add('hidden'); if(gameState.isActive) gameScreen.classList.remove('hidden'); else setupScreen.classList.remove('hidden'); }
    function handleBackToMenu() { if (gameState.isActive) showCustomConfirm('Porzucić obecną grę? Postęp nie zostanie zapisany.', resetGame); else resetGame(); }
    let currentYesHandler, currentNoHandler;
    function showCustomAlert(msg) { showCustomConfirm(msg, () => {}, false); }
    function showCustomConfirm(msg, onConfirm, showNo = true) { confirmMessage.textContent = msg; confirmModal.classList.add('flex'); confirmModal.classList.remove('hidden'); confirmNoBtn.classList.toggle('hidden', !showNo); if (!showNo) { confirmYesBtn.textContent = 'OK'; confirmYesBtn.classList.remove('bg-red-600', 'w-1/2'); confirmYesBtn.classList.add('btn-primary', 'w-full'); } else { confirmYesBtn.textContent = 'Tak'; confirmYesBtn.classList.add('bg-red-600', 'w-1/2'); confirmYesBtn.classList.remove('btn-primary', 'w-full'); } if (currentYesHandler) confirmYesBtn.removeEventListener('click', currentYesHandler); if (currentNoHandler) confirmNoBtn.removeEventListener('click', currentNoHandler); const cleanUp = () => { confirmModal.classList.add('hidden'); confirmModal.classList.remove('flex'); confirmYesBtn.removeEventListener('click', currentYesHandler); confirmNoBtn.removeEventListener('click', currentNoHandler); confirmYesBtn.textContent = 'Tak'; }; const handleYes = () => { cleanUp(); if (showNo) onConfirm(); }; const handleNo = cleanUp; currentYesHandler = handleYes; currentNoHandler = handleNo; confirmYesBtn.addEventListener('click', currentYesHandler); confirmNoBtn.addEventListener('click', currentNoHandler); }

    // --- Główne ZMIANY w logice statystyk ---

    /**
     * ZMIANA: Funkcja zapisuje już tylko i wyłącznie zwycięstwo gracza,
     * inkrementując jego licznik w kolekcji `tysiac_win_stats`.
     */
    async function saveStats(winner) {
        if (!db) return;

        try {
            const winnerRef = db.collection(FIREBASE_COLLECTION_WINS).doc(winner.name);
            await winnerRef.set({
                name: winner.name,
                wins: firebase.firestore.FieldValue.increment(1)
            }, { merge: true });
            showTemporaryMessage(`Zwycięstwo ${winner.name} zapisane w rankingu!`, false);
        } catch (e) {
            console.error("Błąd zapisu statystyk do Firebase:", e);
            showTemporaryMessage("Błąd zapisu statystyk do Firebase!", true);
        }
    }

    /**
     * ZMIANA: Funkcja pobiera już tylko dane o zwycięstwach.
     * Nie odpytuje o historię gier.
     */
    async function getStatsFromFirebase() {
        if (!db) {
             return { playerWins: {} }; // Zwraca tylko obiekt ze zwycięstwami
        }
        const stats = { playerWins: {} };
        try {
            const winsSnapshot = await db.collection(FIREBASE_COLLECTION_WINS).get();
            winsSnapshot.forEach(doc => {
                const data = doc.data();
                if (data.wins) {
                    stats.playerWins[doc.id] = parseInt(data.wins, 10) || 0;
                }
            });
        } catch (e) {
            console.error("Błąd pobierania statystyk z Firebase:", e);
            showTemporaryMessage("Błąd pobierania statystyk z Firebase!", true);
        }
        return stats;
    }

    /**
     * ZMIANA: Funkcja usuwa już tylko kolekcję ze zwycięstwami.
     */
    async function handleClearStats() {
        showCustomConfirm('Czy na pewno chcesz usunąć WSZYSTKIE statystyki zwycięstw z Firebase? Tej operacji nie można cofnąć.', async () => {
            if (!db) {
                showTemporaryMessage("Brak połączenia z bazą danych.", true);
                return;
            }
            try {
                showTemporaryMessage("Rozpoczynam usuwanie rankingu...", false);
                const winsSnapshot = await db.collection(FIREBASE_COLLECTION_WINS).get();
                const deletePromises = winsSnapshot.docs.map(doc => doc.ref.delete());
                await Promise.all(deletePromises);
                showTemporaryMessage("Wszystkie statystyki zwycięstw zostały usunięte.", false);
                showStats();
            } catch (error) {
                console.error("Błąd podczas usuwania statystyk: ", error);
                showTemporaryMessage("Wystąpił błąd podczas usuwania statystyk.", true);
            }
        });
    }

    /**
     * ZMIANA: Wyświetlanie statystyk zostało całkowicie przebudowane.
     * - Liczy sumę gier na podstawie sumy zwycięstw.
     * - Nie renderuje już listy historycznych gier.
     */
    async function showStats() {
        const stats = await getStatsFromFirebase();

        // Oblicz sumę gier na podstawie sumy wszystkich zwycięstw
        const totalGames = Object.values(stats.playerWins).reduce((sum, current) => sum + current, 0);

        let summaryHtml = `<p class="text-base">Zagrano łącznie: <span class="font-bold text-teal-400">${totalGames}</span> gier</p>`;
        
        const sortedWins = Object.entries(stats.playerWins).sort(([, a], [, b]) => b - a);

        if (sortedWins.length > 0) {
            summaryHtml += `<h4 class="mt-3 mb-2 font-semibold text-sm">Ranking zwycięstw:</h4>`;
            summaryHtml += `<div class="space-y-1 text-sm">`;
            sortedWins.forEach(([name, wins]) => {
                const winPercentage = totalGames > 0 ? ((wins / totalGames) * 100).toFixed(0) : 0;
                summaryHtml += `<div class="flex justify-center gap-2"><span>${name}:</span> <span class="font-semibold">${wins} wygrane (${winPercentage}%)</span></div>`;
            });
            summaryHtml += `</div>`;
        } else {
             summaryHtml += `<p class="mt-3 text-sm text-slate-400">Brak zapisanych gier w rankingu.</p>`;
        }
        statsSummary.innerHTML = summaryHtml;

        setupScreen.classList.add('hidden');
        gameScreen.classList.add('hidden');
        statsScreen.classList.remove('hidden');
    }

    // Event Listeners (bez zmian)
    showStatsBtn.addEventListener('click', showStats);
    gameToStatsBtn.addEventListener('click', showStats);
    backFromStatsBtn.addEventListener('click', handleBackFromStats);
    playerCountSelect.addEventListener('change', generatePlayerNameInputs);
    startGameBtn.addEventListener('click', startGame);
    addRoundBtn.addEventListener('click', addRoundScore);
    rotateFirstPlayerBtn.addEventListener('click', rotateFirstPlayer);
    backToMenuBtn.addEventListener('click', handleBackToMenu);
    modalBackToMenuBtn.addEventListener('click', resetGame);
    clearStatsBtn.addEventListener('click', handleClearStats);

    // Inicjalizacja (bez zmian)
    if (!loadGameState()) {
        generatePlayerNameInputs();
    }
</script>
</body>
</html>




